{{!-- Eon IV Combat Tracker - Phases Panel --}}

<div class="eon-phases-container">
  {{#if hasCombat}}
    {{!-- Header with round info and controls --}}
    <header class="eon-phases-header">
      <h2>Runda {{round}}</h2>
      {{#if canModify}}
        <div class="eon-header-controls">
          <button type="button" data-action="clear-all" title="Återställ alla faser">
            <i class="fas fa-undo"></i> Återställ
          </button>
        </div>
      {{/if}}
    </header>

    {{!-- Phase list (vertical stack) --}}
    <div class="eon-phases-list">
      {{#each phases}}
        <div class="eon-phase-section" data-phase="{{id}}">
          <div class="eon-phase-header">
            <div class="eon-phase-header-left" data-action="toggle-phase">
              <i class="fas {{icon}}"></i>
              <span class="eon-phase-title">{{label}}</span>
              <span class="eon-phase-count">{{count}}</span>
            </div>
            <div class="eon-phase-header-right">
              <i class="fas fa-chevron-down eon-phase-toggle" data-action="toggle-phase"></i>
            </div>
          </div>
          
          <ul class="eon-combatant-list" data-phase="{{id}}">
            {{#each combatants}}
              <li class="eon-combatant-row {{#if defeated}}defeated{{/if}} {{#if meleeRole}}melee-{{meleeRole}}{{/if}} {{#if engagedWith}}eon-engaged{{/if}}" 
                  data-combatant-id="{{id}}"
                  data-phase="{{../id}}"
                  draggable="true">
                {{#if isMelee}}
                  {{#if meleeRole}}
                    {{#if isAttacker}}
                      <i class="fas fa-sword eon-melee-role-icon eon-attacker-icon" title="Anfallare"></i>
                    {{/if}}
                    {{#if isDefender}}
                      <i class="fas fa-shield-alt eon-melee-role-icon eon-defender-icon" title="Försvarare"></i>
                    {{/if}}
                  {{/if}}
                {{/if}}
                <img class="eon-combatant-img" src="{{img}}" alt="{{name}}">
                <span class="eon-combatant-name">{{name}}</span>
                {{#if engagementGroupMemberImages}}
                  <span class="eon-engaged-tokens" title="Engagerad med: {{#each engagementGroupMemberImages}}{{name}}{{#unless @last}}, {{/unless}}{{/each}}">
                    <i class="fas fa-link eon-link-icon"></i>
                    {{#each engagementGroupMemberImages}}
                      <img class="eon-engaged-token-img" src="{{img}}" alt="{{name}}" title="{{name}}">
                    {{/each}}
                  </span>
                {{else if engagedWithName}}
                  <span class="eon-engaged-label" title="Engagerad med {{engagedWithName}}">
                    <i class="fas fa-link"></i> {{engagedWithName}}
                  </span>
                {{/if}}
                <div class="eon-combatant-controls">
                  {{#if reactionRoll}}
                    <span class="eon-reaction-roll" title="Reaktionsslag: {{reactionRoll}}">{{reactionRoll}}</span>
                  {{/if}}
                  {{#if isMelee}}
                    {{#if canInteract}}
                      {{#if canModify}}
                        {{#if engagementGroup}}
                          <button type="button" 
                                  class="eon-toggle-role-btn" 
                                  data-action="toggle-role" 
                                  data-combatant-id="{{id}}"
                                  draggable="false"
                                  title="Växla roll: Byt mellan Anfallare och Försvarare">
                            <i class="fas fa-exchange-alt"></i>
                          </button>
                          <button type="button" 
                                  class="eon-disengage-btn" 
                                  data-action="disengage" 
                                  data-combatant-id="{{id}}"
                                  draggable="false"
                                  title="Avsluta närstrid: Ta bort engagemang">
                            <i class="fas fa-unlink"></i>
                          </button>
                        {{else if engagedWith}}
                          <button type="button" 
                                  class="eon-toggle-role-btn" 
                                  data-action="toggle-role" 
                                  data-combatant-id="{{id}}"
                                  draggable="false"
                                  title="Växla roll: Byt mellan Anfallare och Försvarare">
                            <i class="fas fa-exchange-alt"></i>
                          </button>
                          <button type="button" 
                                  class="eon-disengage-btn" 
                                  data-action="disengage" 
                                  data-combatant-id="{{id}}"
                                  draggable="false"
                                  title="Avsluta närstrid: Ta bort engagemang">
                            <i class="fas fa-unlink"></i>
                          </button>
                        {{else}}
                          <button type="button" 
                                  class="eon-engage-btn" 
                                  data-action="engage" 
                                  data-combatant-id="{{id}}"
                                  draggable="false"
                                  title="Engagera i närstrid: Öppnar en dialog för att välja vilka stridande som ska engagera tillsammans">
                            <i class="fas fa-link"></i>
                          </button>
                        {{/if}}
                      {{/if}}
                    {{/if}}
                  {{/if}}
                  {{#if defeated}}
                    <i class="fas fa-skull eon-defeated-icon" title="Besegrad"></i>
                  {{/if}}
                </div>
              </li>
            {{else}}
              <li class="eon-combatant-empty">
                <em>Ingen i denna fas</em>
              </li>
            {{/each}}
          </ul>
        </div>
      {{/each}}
    </div>

  {{else}}
    {{!-- No active combat --}}
    <div class="eon-no-combat">
      <i class="fas fa-exclamation-triangle"></i>
      <p>Ingen aktiv strid.</p>
      <p class="eon-hint">Starta en strid för att använda stridshanteraren.</p>
    </div>
  {{/if}}
</div>

